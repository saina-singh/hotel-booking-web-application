{# Reusable topbar for ALL admin pages #}
<div class="admin-topbar">
  <div>
    <h2 class="fw-bold mb-0">{{ title or "Admin" }}</h2>
    <div class="text-muted small">Welcome, {{ session.get('email') }}</div>
  </div>

  <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end" style="flex:1;">
    <div class="admin-search position-relative">
      <i class="bi bi-search text-muted"></i>
      <input id="adminSearchInput" type="text" placeholder="Search cities, rooms, users..." autocomplete="off" />

      <!-- dropdown results -->
      <div id="adminSearchResults" class="admin-search-results d-none"></div>
    </div>

    <div class="top-icons">
      <button class="icon-btn" type="button" title="Messages"><i class="bi bi-chat-dots"></i></button>
      <button class="icon-btn" type="button" title="Notifications"><i class="bi bi-bell"></i></button>
    </div>
  </div>
</div>

<script>
  (function () {
    const input = document.getElementById("adminSearchInput");
    const box = document.getElementById("adminSearchResults");
    if (!input || !box) return;

    let t = null;

    function hideBox() {
      box.classList.add("d-none");
      box.innerHTML = "";
    }

    function showBox() {
      box.classList.remove("d-none");
    }

    function esc(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    function renderGroup(title, items, kind) {
      if (!items || items.length === 0) return "";
      let html = `<div class="as-group-title">${esc(title)}</div>`;
      items.forEach(it => {
        if (kind === "city") {
          html += `
          <button type="button" class="as-item" data-kind="city" data-name="${esc(it.name)}">
            <i class="bi bi-geo-alt me-2 text-muted"></i>
            <span>${esc(it.name)}</span>
          </button>`;
        }
        if (kind === "room") {
          html += `
          <button type="button" class="as-item" data-kind="room" data-code="${esc(it.code)}">
            <i class="bi bi-door-open me-2 text-muted"></i>
            <span class="fw-semibold">${esc(it.code)}</span>
            <span class="text-muted ms-2 small">max guests: ${esc(it.max_guests)}</span>
          </button>`;
        }
        if (kind === "user") {
          const label = `${it.first_name || ""} ${it.last_name || ""}`.trim() || it.email;
          html += `
          <button type="button" class="as-item" data-kind="user" data-q="${esc(it.email)}">
            <i class="bi bi-person me-2 text-muted"></i>
            <span>${esc(label)}</span>
            <span class="text-muted ms-2 small">${esc(it.email)}</span>
          </button>`;
        }
      });
      return html;
    }

    async function fetchResults(q) {
      const res = await fetch(`{{ url_for('admin_search') }}?q=${encodeURIComponent(q)}`);
      if (!res.ok) return { cities: [], rooms: [], users: [] };
      return await res.json();
    }

    input.addEventListener("input", () => {
      const q = input.value.trim();
      clearTimeout(t);

      if (q.length < 1) { hideBox(); return; }

      t = setTimeout(async () => {
        try {
          const data = await fetchResults(q);

          const html =
            renderGroup("Cities", data.cities, "city") +
            renderGroup("Room Types", data.rooms, "room") +
            renderGroup("Users", data.users, "user");

          if (!html) {
            box.innerHTML = `<div class="as-empty">No results found.</div>`;
            showBox();
            return;
          }

          box.innerHTML = html;
          showBox();
        } catch (e) {
          hideBox();
        }
      }, 200);
    });

    // click outside closes
    document.addEventListener("click", (e) => {
      if (!box.contains(e.target) && e.target !== input) hideBox();
    });

    // click a result
    box.addEventListener("click", (e) => {
      const btn = e.target.closest(".as-item");
      if (!btn) return;

      const kind = btn.dataset.kind;

      // Cities + Rooms -> go to public hotels page with filters (reliable with your current routes)
      if (kind === "city") {
        const name = btn.dataset.name || "";
        window.location.href = `{{ url_for('hotels') }}?city=${encodeURIComponent(name)}`;
      }
      if (kind === "room") {
        const code = btn.dataset.code || "";
        window.location.href = `{{ url_for('hotels') }}?room=${encodeURIComponent(code)}`;
      }

      // Users -> go to admin users page with search query
      if (kind === "user") {
        const q = btn.dataset.q || "";
        window.location.href = `{{ url_for('admin_users') }}?q=${encodeURIComponent(q)}`;
      }
    });

    // Enter key behavior
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const q = input.value.trim();
        if (!q) return;
        // Default: go to admin users search page (best place for admin searching)
        window.location.href = `{{ url_for('admin_users') }}?q=${encodeURIComponent(q)}`;
      }
      if (e.key === "Escape") hideBox();
    });
  })();
</script>