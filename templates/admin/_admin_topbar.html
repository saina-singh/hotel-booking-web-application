{# Reusable topbar for ALL admin pages (except admin_dashboard if you want) #}
<div class="admin-topbar">
  <div class="admin-topbar-left">
    <h2 class="fw-bold mb-0">Admin</h2>
    <div class="text-muted small">Welcome, {{ session.get('email') }}</div>
  </div>

  <div class="admin-topbar-search">
    <div class="admin-search">
      <i class="bi bi-search text-muted"></i>
      <input id="adminSearchInput" type="text" placeholder="Search cities, rooms, users..." autocomplete="off" />
      <div id="adminSearchDropdown" class="admin-search-dd d-none"></div>
    </div>
  </div>

  <div class="admin-topbar-right">
    <button class="icon-btn" type="button" title="Messages"><i class="bi bi-chat-dots"></i></button>
    <button class="icon-btn" type="button" title="Notifications"><i class="bi bi-bell"></i></button>
  </div>
</div>

<script>
  (function () {
    const input = document.getElementById("adminSearchInput");
    const box = document.getElementById("adminSearchDropdown");
    if (!input || !box) return;

    let t = null;

    function hideBox() {
      box.classList.add("d-none");
      box.innerHTML = "";
    }

    function showBox(html) {
      box.innerHTML = html;
      box.classList.remove("d-none");
    }

    function esc(s) {
      return (s ?? "").toString().replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    function renderGroup(title, items, kind) {
      if (!items || items.length === 0) return "";
      let html = `<div class="dd-title">${esc(title)}</div>`;

      items.forEach(it => {
        if (kind === "city") {
          html += `
            <div class="dd-item" data-kind="city" data-name="${esc(it.name)}">
              <b>${esc(it.name)}</b>
            </div>`;
        }

        if (kind === "room") {
          html += `
            <div class="dd-item" data-kind="room" data-code="${esc(it.code)}">
              <b>${esc(it.code)}</b> <span class="dd-muted">• max ${esc(it.max_guests)}</span>
            </div>`;
        }

        if (kind === "user") {
          const label = `${it.first_name || ""} ${it.last_name || ""}`.trim() || it.email;
          html += `
            <div class="dd-item" data-kind="user" data-q="${esc(it.email)}">
              <b>${esc(label)}</b> <span class="dd-muted">• ${esc(it.email)} • ${esc(it.role || "")}</span>
            </div>`;
        }
      });

      return html;
    }

    async function fetchResults(q) {
      const res = await fetch(`{{ url_for('admin_search') }}?q=${encodeURIComponent(q)}`);
      if (!res.ok) return { cities: [], rooms: [], users: [] };
      return await res.json();
    }

    input.addEventListener("input", () => {
      const q = input.value.trim();
      clearTimeout(t);

      if (!q) { hideBox(); return; }

      t = setTimeout(async () => {
        try {
          const data = await fetchResults(q);

          const html =
            renderGroup("Cities", data.cities, "city") +
            renderGroup("Room Types", data.rooms, "room") +
            renderGroup("Users", data.users, "user");

          if (!html) {
            showBox(`<div class="p-3 text-muted small">No results found.</div>`);
            return;
          }

          showBox(html);
        } catch (e) {
          hideBox();
        }
      }, 220);
    });

    // click outside closes
    document.addEventListener("click", (e) => {
      if (!box.contains(e.target) && e.target !== input) hideBox();
    });

    // click a result
    box.addEventListener("click", (e) => {
      const item = e.target.closest(".dd-item");
      if (!item) return;

      const kind = item.dataset.kind;

      if (kind === "city") {
        const name = item.dataset.name || "";
        window.location.href = `{{ url_for('hotels') }}?city=${encodeURIComponent(name)}`;
      }

      if (kind === "room") {
        const code = item.dataset.code || "";
        window.location.href = `{{ url_for('hotels') }}?room=${encodeURIComponent(code)}`;
      }

      if (kind === "user") {
        const q = item.dataset.q || "";
        window.location.href = `{{ url_for('admin_users') }}?q=${encodeURIComponent(q)}`;
      }

      hideBox();
    });

    // Enter key behavior
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        const q = input.value.trim();
        if (!q) return;
        window.location.href = `{{ url_for('admin_users') }}?q=${encodeURIComponent(q)}`;
      }
      if (e.key === "Escape") hideBox();
    });
  })();
</script>