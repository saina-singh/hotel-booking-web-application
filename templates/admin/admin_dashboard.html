{% extends 'base.html' %}

{% block head %}
<title>Admin Dashboard</title>
{% endblock %}

{% block body %}
<div class="container admin-page py-4">
  <div class="admin-shell">

    <!-- SIDEBAR -->
    <aside class="admin-sidebar">
      <div class="admin-brand">Admin Dashboard</div>

      <nav class="admin-nav">

        <!-- Dashboard -->
        <a href="{{ url_for('admin_dashboard') }}" class="{% if endpoint == 'admin_dashboard' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-speedometer2"></i></div>
          <div class="fw-semibold">Dashboard</div>
        </a>

        <!-- Reservations -->
        <a href="{{ url_for('admin_reservations') }}"
          class="{% if endpoint == 'admin_reservations' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-calendar-check"></i></div>
          <div class="fw-semibold">Reservations</div>
        </a>

        <!-- Rooms -->
        <a href="{{ url_for('admin_rooms') }}" class="{% if endpoint == 'admin_rooms' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-door-open"></i></div>
          <div class="fw-semibold">Rooms</div>
        </a>

        <!-- Staff -->
        <a href="{{ url_for('admin_staffs') }}" class="{% if endpoint == 'admin_staffs' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-people"></i></div>
          <div class="fw-semibold">Staffs</div>
        </a>

        <!-- Analytics -->
        <a href="{{ url_for('admin_analytics') }}" class="{% if endpoint == 'admin_analytics' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-bar-chart"></i></div>
          <div class="fw-semibold">Analytics</div>
        </a>

        <!-- Reports -->
        <a href="{{ url_for('admin_reports') }}" class="{% if endpoint == 'admin_reports' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-file-earmark-text"></i></div>
          <div class="fw-semibold">Reports</div>
        </a>

        <!-- Settings -->
        <a href="{{ url_for('admin_settings') }}" class="{% if endpoint == 'admin_settings' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-gear"></i></div>
          <div class="fw-semibold">Settings</div>
        </a>

        <a href="{{ url_for('admin_users') }}" class="{% if endpoint == 'admin_users' %}active{% endif %}">
          <div class="admin-icon"><i class="bi bi-person-badge"></i></div>
          <div class="fw-semibold">Users</div>
        </a>

      </nav>
    </aside>

    <!-- MAIN -->
    <main class="admin-main">

      <!-- TOPBAR -->
      <div class="admin-topbar">
        <div>
          <h2 class="fw-bold mb-0">Admin Dashboard</h2>
          <div class="text-muted small">Welcome, {{ session.get('email') }}</div>
        </div>

        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end" style="flex:1;">
          <div class="admin-search">
            <i class="bi bi-search text-muted"></i>
            <input id="adminSearchInput" type="text" placeholder="Search city, room, user..." />
            <div id="adminSearchDropdown" class="admin-search-dd d-none"></div>
          </div>

          <div class="top-icons">
            <button class="icon-btn" type="button" title="Messages"><i class="bi bi-chat-dots"></i></button>
            <button class="icon-btn" type="button" title="Notifications"><i class="bi bi-bell"></i></button>
          </div>
        </div>
      </div>

      <!-- KPI ROW -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Total Revenue</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">£32,800</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 3.17%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">New Bookings</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">109</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 2.28%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Check-in</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">89</div>
              <div class="kpi-sub">
                <span class="pill red">↘ 2.28%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Check-out</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">17</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 0.97%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MIDDLE ROW -->
      <div class="row g-3 mb-4">
        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Guests</div>
                <select id="guestsRange" class="form-select form-select-sm" style="max-width: 140px;">
                  <option value="week" selected>This Week</option>
                  <option value="lastWeek">Last Week</option>
                  <option value="month">This Month</option>
                </select>

              </div>
              <div style="height:170px;">
                <canvas id="guestsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Revenue</div>
                <select id="revenueRange" class="form-select form-select-sm" style="max-width: 160px;">
                  <option value="8m" selected>Last 8 months</option>
                  <option value="6m">Last 6 months</option>
                  <option value="year">This Year</option>
                </select>

              </div>
              <div style="height:170px;">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="panel-title mb-2">Overall Ratings</div>

              <div class="d-flex align-items-center gap-3 mb-3">
                <div class="border rounded-3 px-3 py-2 fw-bold"
                  style="font-size: 24px; min-width: 80px; text-align:center;">
                  4.9
                </div>
                <div>
                  <div class="fw-bold">Excellent</div>
                  <div class="text-muted small">1,024 verified users</div>
                </div>
              </div>

              {% set rows = [
              ('Cleanliness', 48),
              ('Facilities', 49),
              ('Location', 50),
              ('Service', 48),
              ('Value', 49)
              ] %}

              {% for label, pct in rows %}
              <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                  <span class="text-muted">{{ label }}</span>
                  <span class="text-muted">{{ (pct/10)|round(1) }} / 5.0</span>
                </div>
                <div class="ratings-bar">
                  <div style="width: {{ (pct * 2) }}%;"></div>
                </div>
              </div>
              {% endfor %}

            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ROW -->
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Users</div>
                <span class="text-muted small">Total users: <b>{{ total_users }}</b></span>
              </div>

              <div class="table-responsive">
                <table id="usersTable" class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width:80px;">ID</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th style="width:130px;">Role</th>
                      <th style="width:120px;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for u in users %}
                    <tr>
                      <td>{{ u.user_id }}</td>
                      <td class="fw-semibold">{{ u.first_name }} {{ u.last_name }}</td>
                      <td>{{ u.email }}</td>
                      <td>
                        <span class="badge {% if u.role == 'ADMIN' %}bg-dark{% else %}bg-secondary{% endif %}">
                          {{ u.role }}
                        </span>
                      </td>
                      <td>
                        {% if u.is_active == 1 %}
                        <span class="badge bg-success">Active</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Inactive</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="panel-title">Room Occupancy</div>
                  <div class="text-muted small">Quick snapshot</div>
                </div>
                <div class="text-muted">⋮</div>
              </div>

              <div class="d-flex align-items-center gap-3 mt-3">
                <div style="font-size: 34px;">
                  <i class="bi bi-building text-secondary"></i>
                </div>
                <div>
                  <div class="fw-bold" style="font-size: 26px;">90</div>
                  <div class="text-muted small">Total Rooms</div>
                </div>
              </div>

              <div class="mt-3 small">
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-primary me-2"></i>48 occupied</span>
                  <span class="text-muted">today</span>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-purple me-2"></i>13 reserved</span>
                  <span class="text-muted">upcoming</span>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-success me-2"></i>20 available</span>
                  <span class="text-muted">ready</span>
                </div>
                <div class="d-flex justify-content-between py-2">
                  <span><i class="bi bi-circle-fill text-dark me-2"></i>9 not ready</span>
                  <span class="text-muted">maintenance</span>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  Chart.defaults.font.family = "Arial, Helvetica, sans-serif";
  Chart.defaults.color = "#6b7280";

  // -------------------------
  // DATASETS
  // -------------------------
  const guestsDataSets = {
    week: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      data: [34, 41, 38, 55, 49, 62, 58]
    },
    lastWeek: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      data: [28, 33, 31, 40, 44, 50, 47]
    },
    month: {
      labels: ["W1", "W2", "W3", "W4"],
      data: [210, 248, 231, 265]
    }
  };

  const revenueDataSets = {
    "8m": {
      labels: ["Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
      data: [4200, 3800, 5100, 6000, 7200, 6800, 5300, 6100]
    },
    "6m": {
      labels: ["Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
      data: [5100, 6000, 7200, 6800, 5300, 6100]
    },
    year: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      data: [6800, 5300, 6100, 5900, 6400, 7000, 7200, 4200, 3800, 5100, 6000, 7200]
    }
  };

  // -------------------------
  // CREATE CHARTS
  // -------------------------
  const guestsCanvas = document.getElementById("guestsChart");
  const revenueCanvas = document.getElementById("revenueChart");

  let guestsChart = null;
  let revenueChart = null;

  function buildGuestsChart(rangeKey) {
    const set = guestsDataSets[rangeKey] || guestsDataSets.week;

    if (guestsChart) guestsChart.destroy();

    guestsChart = new Chart(guestsCanvas, {
      type: "line",
      data: {
        labels: set.labels,
        datasets: [{
          label: "Guests",
          data: set.data,
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function buildRevenueChart(rangeKey) {
    const set = revenueDataSets[rangeKey] || revenueDataSets["8m"];

    if (revenueChart) revenueChart.destroy();

    revenueChart = new Chart(revenueCanvas, {
      type: "bar",
      data: {
        labels: set.labels,
        datasets: [{
          label: "Revenue (£)",
          data: set.data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  // -------------------------
  // INIT + DROPDOWN LISTENERS
  // -------------------------
  function initAdminCharts() {
    if (!guestsCanvas || !revenueCanvas) return;

    const guestsSelect = document.getElementById("guestsRange");
    const revenueSelect = document.getElementById("revenueRange");

    buildGuestsChart(guestsSelect?.value || "week");
    buildRevenueChart(revenueSelect?.value || "8m");

    guestsSelect?.addEventListener("change", (e) => buildGuestsChart(e.target.value));
    revenueSelect?.addEventListener("change", (e) => buildRevenueChart(e.target.value));
  }

  initAdminCharts();

  const searchInput = document.getElementById("adminSearchInput");
  const usersTable = document.getElementById("usersTable");

  function filterUsersTable(query) {
    if (!usersTable) return;

    const q = query.trim().toLowerCase();
    const rows = usersTable.querySelectorAll("tbody tr");

    rows.forEach(row => {
      const text = row.innerText.toLowerCase();
      row.style.display = text.includes(q) ? "" : "none";
    });
  }

  function smartRedirect(query) {
    const q = query.trim();
    if (!q) return;

    // room codes you use in DB/templates
    const roomCodes = ["STANDARD", "DOUBLE", "FAMILY", "SINGLE", "DELUXE", "SUITE", "EXECUTIVE"];
    const upper = q.toUpperCase();

    const match = roomCodes.find(code =>
      code.includes(upper) || upper.includes(code)
    );

    if (match) {
      window.location.href = `{{ url_for('hotels') }}?room=${encodeURIComponent(match)}`;
      return;
    }

    // Otherwise treat as city search
    window.location.href = `{{ url_for('hotels') }}?city=${encodeURIComponent(q)}`;
  }

  if (searchInput) {
    // live filter users table while typing
    searchInput.addEventListener("input", (e) => {
      filterUsersTable(e.target.value);
    });

    // Enter key redirects to hotels filtered by city/room
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        smartRedirect(searchInput.value);
      }
    });
  }

  const dropdown = document.getElementById("adminSearchDropdown");
  let ddTimer = null;

  function showDropdown(html) {
    if (!dropdown) return;
    dropdown.innerHTML = html;
    dropdown.classList.remove("d-none");
  }

  function hideDropdown() {
    if (!dropdown) return;
    dropdown.classList.add("d-none");
    dropdown.innerHTML = "";
  }

  function esc(s) {
    return (s ?? "").toString().replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[m]));
  }

  async function fetchAdminSearch(q) {
    const res = await fetch(`/admin/search?q=${encodeURIComponent(q)}`);
    if (!res.ok) return { cities: [], rooms: [], users: [] };
    return await res.json();
  }

  function renderResults(data) {
    const cities = data.cities || [];
    const rooms = data.rooms || [];
    const users = data.users || [];

    if (!cities.length && !rooms.length && !users.length) {
      showDropdown(`<div class="p-3 text-muted small">No results</div>`);
      return;
    }

    let html = "";

    if (cities.length) {
      html += `<div class="dd-title">Cities</div>`;
      cities.forEach(c => {
        html += `
          <div class="dd-item" data-type="city" data-value="${esc(c.name)}">
            <b>${esc(c.name)}</b>
          </div>`;
      });
    }

    if (rooms.length) {
      html += `<div class="dd-title">Room types</div>`;
      rooms.forEach(r => {
        html += `
          <div class="dd-item" data-type="room" data-value="${esc(r.code)}">
            <b>${esc(r.code)}</b> <span class="dd-muted">• max ${esc(r.max_guests)}</span>
          </div>`;
      });
    }

    if (users.length) {
      html += `<div class="dd-title">Users</div>`;
      users.forEach(u => {
        const full = `${u.first_name} ${u.last_name}`.trim();
        html += `
          <div class="dd-item" data-type="user" data-userid="${u.user_id}">
            <b>${esc(full)}</b> <span class="dd-muted">• ${esc(u.email)} • ${esc(u.role)}</span>
          </div>`;
      });
    }

    showDropdown(html);
  }

  // Hook into your existing search input
  if (searchInput) {
    searchInput.addEventListener("input", () => {
      // keep your existing table filter
      filterUsersTable(searchInput.value);

      const q = searchInput.value.trim();
      if (!q) { hideDropdown(); return; }

      clearTimeout(ddTimer);
      ddTimer = setTimeout(async () => {
        const data = await fetchAdminSearch(q);
        renderResults(data);
      }, 250);
    });
  }

  // click actions for dropdown items
  if (dropdown) {
    dropdown.addEventListener("click", (e) => {
      const item = e.target.closest(".dd-item");
      if (!item) return;

      const type = item.dataset.type;

      if (type === "city") {
        const city = item.dataset.value;
        window.location.href = `{{ url_for('hotels') }}?city=${encodeURIComponent(city)}`;
      }

      if (type === "room") {
        const code = item.dataset.value;
        window.location.href = `{{ url_for('hotels') }}?room=${encodeURIComponent(code)}`;
      }

      if (type === "user") {
        // simplest: just fill the input to filter the admin table
        const userId = item.dataset.userid;
        searchInput.value = userId;
        filterUsersTable(userId);
      }

      hideDropdown();
    });
  }

  // hide dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (!dropdown || !searchInput) return;
    if (!dropdown.contains(e.target) && e.target !== searchInput) hideDropdown();
  });

</script>


{% endblock %}