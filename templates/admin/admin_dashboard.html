{% extends 'base.html' %}

{% block head %}
<title>Admin Dashboard</title>
{% endblock %}

{% block body %}


<div class="container my-4 admin-page">

  <div class="admin-shell">

    <!-- SIDEBAR -->
    <aside class="admin-sidebar">
      <div class="admin-brand">Admin Dashboard</div>

      <nav class="admin-nav">
        <a class="active" href="{{ url_for('admin_dashboard') }}">
          <div class="admin-icon"><i class="bi bi-speedometer2"></i></div>
          <div>
            <div class="fw-semibold">Dashboard</div>
          </div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-calendar-check"></i></div>
          <div class="fw-semibold">Reservation</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-door-open"></i></div>
          <div class="fw-semibold">Rooms</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-people"></i></div>
          <div class="fw-semibold">Staffs</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-bar-chart"></i></div>
          <div class="fw-semibold">Analytics</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-file-earmark-text"></i></div>
          <div class="fw-semibold">Reports</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-star"></i></div>
          <div class="fw-semibold">Reviews</div>
        </a>

        <a href="#">
          <div class="admin-icon"><i class="bi bi-gear"></i></div>
          <div class="fw-semibold">Settings</div>
        </a>
      </nav>
    </aside>

    <!-- MAIN -->
    <main class="admin-main">

      <!-- TOPBAR -->
      <div class="admin-topbar">
        <div>
          <h2 class="fw-bold mb-0">Admin Dashboard</h2>
          <div class="text-muted small">Welcome, {{ session.get('email') }}</div>
        </div>

        <div class="d-flex align-items-center gap-3 flex-wrap justify-content-end" style="flex:1;">
          <div class="admin-search">
            <i class="bi bi-search text-muted"></i>
            <input type="text" placeholder="Search cities, rooms, etc..." />
          </div>

          <div class="top-icons">
            <button class="icon-btn" type="button" title="Messages"><i class="bi bi-chat-dots"></i></button>
            <button class="icon-btn" type="button" title="Notifications"><i class="bi bi-bell"></i></button>
          </div>
        </div>
      </div>

      <!-- KPI ROW -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Total Revenue</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">£32,800</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 3.17%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">New Bookings</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">109</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 2.28%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Check-in</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">89</div>
              <div class="kpi-sub">
                <span class="pill red">↘ 2.28%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-3">
          <div class="card kpi-card">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="kpi-label">Check-out</div>
                <i class="bi bi-three-dots text-muted"></i>
              </div>
              <div class="kpi-value">17</div>
              <div class="kpi-sub">
                <span class="pill green">↗ 0.97%</span>
                <span>from last week</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MIDDLE ROW -->
      <div class="row g-3 mb-4">
        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Guests</div>
                <select id="guestsRange" class="form-select form-select-sm" style="max-width: 140px;">
                  <option value="week" selected>This Week</option>
                  <option value="lastWeek">Last Week</option>
                  <option value="month">This Month</option>
                </select>
              </div>
              <div style="height:170px;">
                <canvas id="guestsChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Revenue</div>
                <select id="revenueRange" class="form-select form-select-sm" style="max-width: 160px;">
                  <option value="8m" selected>Last 8 months</option>
                  <option value="6m">Last 6 months</option>
                  <option value="year">This Year</option>
                </select>
              </div>
              <div style="height:170px;">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="panel-title mb-2">Overall Ratings</div>

              <div class="d-flex align-items-center gap-3 mb-3">
                <div class="border rounded-3 px-3 py-2 fw-bold"
                  style="font-size: 24px; min-width: 80px; text-align:center;">
                  4.9
                </div>
                <div>
                  <div class="fw-bold">Excellent</div>
                  <div class="text-muted small">1,024 verified users</div>
                </div>
              </div>

              {% set rows = [
              ('Cleanliness', 48),
              ('Facilities', 49),
              ('Location', 50),
              ('Service', 48),
              ('Value', 49)
              ] %}

              {% for label, pct in rows %}
              <div class="mb-3">
                <div class="d-flex justify-content-between small mb-1">
                  <span class="text-muted">{{ label }}</span>
                  <span class="text-muted">{{ (pct/10)|round(1) }} / 5.0</span>
                </div>
                <div class="ratings-bar">
                  <div style="width: {{ (pct * 2) }}%;"></div>
                </div>
              </div>
              {% endfor %}

            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ROW -->
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="panel-title">Users</div>
                <span class="text-muted small">Total users: <b>{{ total_users }}</b></span>
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="width:80px;">ID</th>
                      <th>Name</th>
                      <th>Email</th>
                      <th style="width:130px;">Role</th>
                      <th style="width:120px;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for u in users %}
                    <tr>
                      <td>{{ u.user_id }}</td>
                      <td class="fw-semibold">{{ u.first_name }} {{ u.last_name }}</td>
                      <td>{{ u.email }}</td>
                      <td>
                        <span class="badge {% if u.role == 'ADMIN' %}bg-dark{% else %}bg-secondary{% endif %}">
                          {{ u.role }}
                        </span>
                      </td>
                      <td>
                        {% if u.is_active == 1 %}
                        <span class="badge bg-success">Active</span>
                        {% else %}
                        <span class="badge bg-warning text-dark">Inactive</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card panel-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="panel-title">Room Occupancy</div>
                  <div class="text-muted small">Quick snapshot</div>
                </div>
                <div class="text-muted">⋮</div>
              </div>

              <div class="d-flex align-items-center gap-3 mt-3">
                <div style="font-size: 34px;">
                  <i class="bi bi-building text-secondary"></i>
                </div>
                <div>
                  <div class="fw-bold" style="font-size: 26px;">90</div>
                  <div class="text-muted small">Total Rooms</div>
                </div>
              </div>

              <div class="mt-3 small">
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-primary me-2"></i>48 occupied</span>
                  <span class="text-muted">today</span>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-purple me-2"></i>13 reserved</span>
                  <span class="text-muted">upcoming</span>
                </div>
                <div class="d-flex justify-content-between py-2 border-bottom">
                  <span><i class="bi bi-circle-fill text-success me-2"></i>20 available</span>
                  <span class="text-muted">ready</span>
                </div>
                <div class="d-flex justify-content-between py-2">
                  <span><i class="bi bi-circle-fill text-dark me-2"></i>9 not ready</span>
                  <span class="text-muted">maintenance</span>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  Chart.defaults.font.family = "Arial, Helvetica, sans-serif";
  Chart.defaults.color = "#6b7280";

  // -------------------------
  // DATASETS
  // -------------------------
  const guestsDataSets = {
    week: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      data: [34, 41, 38, 55, 49, 62, 58]
    },
    lastWeek: {
      labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
      data: [28, 33, 31, 40, 44, 50, 47]
    },
    month: {
      labels: ["W1", "W2", "W3", "W4"],
      data: [210, 248, 231, 265]
    }
  };

  const revenueDataSets = {
    "8m": {
      labels: ["Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
      data: [4200, 3800, 5100, 6000, 7200, 6800, 5300, 6100]
    },
    "6m": {
      labels: ["Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
      data: [5100, 6000, 7200, 6800, 5300, 6100]
    },
    year: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      data: [6800, 5300, 6100, 5900, 6400, 7000, 7200, 4200, 3800, 5100, 6000, 7200]
    }
  };

  // -------------------------
  // CREATE CHARTS
  // -------------------------
  const guestsCanvas = document.getElementById("guestsChart");
  const revenueCanvas = document.getElementById("revenueChart");

  let guestsChart = null;
  let revenueChart = null;

  function buildGuestsChart(rangeKey) {
    const set = guestsDataSets[rangeKey] || guestsDataSets.week;

    if (guestsChart) guestsChart.destroy();

    guestsChart = new Chart(guestsCanvas, {
      type: "line",
      data: {
        labels: set.labels,
        datasets: [{
          label: "Guests",
          data: set.data,
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  function buildRevenueChart(rangeKey) {
    const set = revenueDataSets[rangeKey] || revenueDataSets["8m"];

    if (revenueChart) revenueChart.destroy();

    revenueChart = new Chart(revenueCanvas, {
      type: "bar",
      data: {
        labels: set.labels,
        datasets: [{
          label: "Revenue (£)",
          data: set.data,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false } },
          y: { beginAtZero: true }
        }
      }
    });
  }

  // -------------------------
  // INIT + DROPDOWN LISTENERS
  // -------------------------
  function initAdminCharts() {
    if (!guestsCanvas || !revenueCanvas) return;

    const guestsSelect = document.getElementById("guestsRange");
    const revenueSelect = document.getElementById("revenueRange");

    buildGuestsChart(guestsSelect?.value || "week");
    buildRevenueChart(revenueSelect?.value || "8m");

    guestsSelect?.addEventListener("change", (e) => buildGuestsChart(e.target.value));
    revenueSelect?.addEventListener("change", (e) => buildRevenueChart(e.target.value));
  }

  initAdminCharts();
</script>


{% endblock %}